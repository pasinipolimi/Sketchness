@(username: String)(env: PaintRoom)

@main(username) {
    
    <div class="page-header" id="pageheader">
        <h1>You are <span id="roleSpan">waiting...</span>  <small>You are playing as <span id="nickname">@username</span></small></h1>
    </div>
    
    <div id="onError" class="alert-message error">
        <p>
            <strong>Oops! </strong><span></span>
        </p>
    </div>
    
    <div id="mainPage" class="row">
		<div id="gameArea" class="span10">  
                          <span id="gameMessagesSpan">
                                  <canvas id="gameMessages" height="50" width="500"></canvas>
                          </span>
			  <span id="viewport">
				  <canvas id="me" width="500" height="450"></canvas>
				  <canvas id="positions" width="500" height="450"></canvas>
				  <canvas id="draws" width="500" height="450"></canvas>
			  </span>
			  <span>
				  <canvas id="controls" width="88" height="450"></canvas>
			  </span>
		</div>
		<script type="text/javascript" src="/assets/javascripts/paint.js"></script>
		
        <div id="chatPanel" class="span4">
            <div id="messages">
            </div>
            <textarea id="talk"></textarea>
		</div>
		<div class="span2">
				<h2>Players</h2>
				<ul id="members">
				</ul>
		</div>
	</div>
	<script type="text/javascript">
			(function() {
					var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket
					var chatSocket = new WS("@routes.Application.chat(username).webSocketURL(request)")
					
					var sendMessage = function() {
						chatSocket.send(JSON.stringify(
							{text: $("#talk").val()}
						))
						$("#talk").val('')
					}
					
					var receiveEvent = function(event) {
						var data = JSON.parse(event.data)
						
						// Handle errors
						if(data.error) {
							chatSocket.close()
							$("#onError span").text(data.error)
							$("#onError").show()
							$("#pageheader").hide()
							return
						} else {
							$("#onChat").show()
						}
						
						// Create the message element
						var el = $('<div class="message"><span></span><p></p></div>')
						$("span", el).text(data.user)
						$("p", el).text(data.message)
						$(el).addClass(data.kind)
						if(data.user == '@username') $(el).addClass('me')
						$('#messages').append(el)
						
						// Update the members list
						$("#members").html('') 
						$(data.members).each(function() {
							$("#members").append('<li>' + this + '</li>')
						})
					}
					
					var handleReturnKey = function(e) {
						if(e.charCode == 13 || e.keyCode == 13) {
							e.preventDefault()
							sendMessage()
						} 
					}
					
					$("#talk").keypress(handleReturnKey) 
					
					chatSocket.onmessage = receiveEvent
					
		})()
	</script>
}